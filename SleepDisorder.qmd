---
title: "Sleep Disorder"
format: html
---

## Sleep Health and Lifestyle Analysis Project

By:

1.  Amabel Nabila (455854)

    -   Data Visualization and Analysis

2.  Mustafa Ceyhun Vural (455158)

    -   Machine Learning

3.  Onur Durmus (455860)

    -   Machine Learning

4.  Zehra Usta (455847)

    -   Data Visualization and Analysis

## Project Objective

This project serves as the final assignment for the Reproducible Research course. It utilizes a dataset sourced from Kaggle and involves translating the code from Python to R. The aim of this project is to analyze the sleep health of individuals based on their respective lifestyles, incorporating machine learning techniques to enhance the analysis. Variables in this project include:

-   Gender

-   Age

-   Occupation

-   Sleep Duration

-   Quality of Sleep

-   Physical Activity Level

-   Stress Level

-   BMI Category

-   Blood Pressure

-   Heart Rate

-   Daily Steps

-   Sleep Disorder

## Introduction

Sleep disorders (or sleep-wake disorders) are difficulties with the quality, timing, and quantity of sleep that cause daily discomfort and impairment in functioning. Sleep-wake disturbances are frequently associated with physical or mental health illnesses such as depression, anxiety, or cognitive difficulties. There are various forms of sleep-wake disorders, with insomnia being the most frequent. Other sleep-wake problems include sleep apnea. Insomnia is a common sleep problem that makes it difficult to get asleep and remain asleep. Meanwhile, sleep apnea is a condition in which you stop breathing while asleep.

## Library

```{r}
# Libraries used
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(corrplot)
library(ggExtra)
library(gbm)
library(caret)
library(caTools)  
library(stats) 
library(GGally)
```



## Data

```{r}
# Read the data
data <- read.csv('Sleep_health_and_lifestyle_dataset.csv')
```

## Data Cleaning

```{r}
# Drop NA (if existed)
data <- na.omit(data)

# Standardize "Normal Weight" and "normal" to "Normal" in "BMI Category"
data <- data %>%
  mutate(BMI.Category = ifelse(BMI.Category %in% c("Normal Weight", "normal"), "Normal", BMI.Category))

# View data cleaned
head(data)
```

We delete NA data and also correct the values ​​in the dataset because normal weight and normal are the same.

```{r}
# Split the Blood.Pressure column into two new columns and convert to numeric
data <- data %>%
  separate(col = Blood.Pressure, into = c("Systolic Pressure", "Diastolic Pressure"), sep = "/", convert = TRUE) %>%
  mutate(`Systolic Pressure` = as.numeric(`Systolic Pressure`),
         `Diastolic Pressure` = as.numeric(`Diastolic Pressure`))

# Check the structure of the updated data frame
str(data)
```
```{r}
# Summary statistics
summary(data)

```

```{r}
# Define a function to categorize blood pressure
categorize_blood_pressure <- function(systolic, diastolic) {
  if (is.na(systolic) | is.na(diastolic)) {
    return(NA)
  } else if (systolic < 120 & diastolic < 80) {
    return('Optimal')
  } else if (systolic <= 139 | diastolic <= 89) {
    return('Normal')
  } else if (systolic >= 140 | diastolic >= 90) {
    return('Hypertension')
  } else {
    return('Other')
  }
}

# Apply the categorization function to create the Blood Pressure Category column
data <- data %>%
  rowwise() %>%
  mutate(`Blood.Pressure.Category` = categorize_blood_pressure(`Systolic Pressure`, `Diastolic Pressure`))

# View the newest data
head(data)
```
## Data Visualization

```{r}
age_groups <- data %>%
  mutate(Age.Group = case_when(
    Age <= 35 ~ "35 and below",
    Age > 35 ~ "35 and above"
  ))

ggplot(age_groups, aes(x = Age.Group, y = Sleep.Duration, fill = Age.Group)) +
  geom_bar(stat = "summary", fun = "mean") +
  labs(title = "Mean Sleep Duration by Age Group", x = "Age Group", y = "Mean Sleep Duration (hours)") +
  theme_minimal()

ggplot(age_groups, aes(x = Age.Group, y = Quality.of.Sleep, fill = Age.Group)) +
  geom_bar(stat = "summary", fun = "mean") +
  labs(title = "Mean Quality of Sleep by Age Group", x = "Age Group", y = "Mean Quality of Sleep") +
  theme_minimal()

ggplot(age_groups, aes(x = Age.Group, y = Physical.Activity.Level, fill = Age.Group)) +
  geom_bar(stat = "summary", fun = "mean") +
  labs(title = "Mean Physical Activity Level by Age Group", x = "Age Group", y = "Mean Physical Activity Level") +
  theme_minimal()

ggplot(age_groups, aes(x = Age.Group, y = Stress.Level, fill = Age.Group)) +
  geom_bar(stat = "summary", fun = "mean") +
  labs(title = "Mean Stress Level by Age Group", x = "Age Group", y = "Mean Stress Level") +
  theme_minimal()


```

```{r}

# Pair plot of the selected variables
ggpairs(data %>% select(Sleep.Duration, Quality.of.Sleep, Physical.Activity.Level, Stress.Level))

```

```{r}
ggplot(data, aes(x = Stress.Level)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  labs(title = "Density Plot of Stress Level", x = "Stress Level", y = "Density") +
  theme_minimal()

ggplot(data, aes(x = Physical.Activity.Level)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  labs(title = "Density Plot of Stress Level", x = "Stress Level", y = "Density") +
  theme_minimal()

ggplot(data, aes(x = Sleep.Duration)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  labs(title = "Density Plot of Stress Level", x = "Stress Level", y = "Density") +
  theme_minimal()

```

```{r}
# Create a box plot for Age distribution
age_boxplot <- ggplot(data, aes(x = '', y = Age)) + 
  geom_boxplot() +
  labs(title = "Age Distribution", y = "Age", x = "") +
  theme_minimal()

# Create a histogram for Age distribution
age_histogram <- ggplot(data, aes(x = Age)) + 
  geom_histogram(binwidth = 1, fill = "lightblue", color = "black") +
  labs(title = "Age Distribution", x = "Age", y = "Count") +
  theme_minimal()

# Create a box plot for Quality of Sleep distribution
quality_of_sleep_boxplot <- ggplot(data, aes(x = '', y = Quality.of.Sleep)) + 
  geom_boxplot() +
  labs(title = "Quality of Sleep Distribution", y = "Quality of Sleep", x = "") +
  theme_minimal()

# Create a histogram for Quality of Sleep distribution
quality_of_sleep_histogram <- ggplot(data, aes(x = Quality.of.Sleep)) + 
  geom_histogram(binwidth = 0.5, fill = "lightblue", color = "black") +
  labs(title = "Quality of Sleep Distribution", x = "Quality of Sleep", y = "Count") +
  theme_minimal()

# Create a box plot for Physical Activity Level distribution
physical_activity_boxplot <- ggplot(data, aes(x = '', y = Physical.Activity.Level)) + 
  geom_boxplot() +
  labs(title = "Physical Activity Level Distribution", y = "Physical Activity Level", x = "") +
  theme_minimal()

# Create a histogram for Physical Activity Level distribution
physical_activity_histogram <- ggplot(data, aes(x = Physical.Activity.Level)) + 
  geom_histogram(binwidth = 5, fill = "lightblue", color = "black") +
  labs(title = "Physical Activity Level Distribution", x = "Physical Activity Level", y = "Count") +
  theme_minimal()

# Create a box plot for Stress Level distribution
stress_level_boxplot <- ggplot(data, aes(x = '', y = Stress.Level)) + 
  geom_boxplot() +
  labs(title = "Stress Level Distribution", y = "Stress Level", x = "") +
  theme_minimal()

# Create a histogram for Stress Level distribution
stress_level_histogram <- ggplot(data, aes(x = Stress.Level)) + 
  geom_histogram(binwidth = 1, fill = "lightblue", color = "black") +
  labs(title = "Stress Level Distribution", x = "Stress Level", y = "Count") +
  theme_minimal()

# Create a box plot for Heart Rate distribution
heart_rate_boxplot <- ggplot(data, aes(x = '', y = Heart.Rate)) + 
  geom_boxplot() +
  labs(title = "Heart Rate Distribution", y = "Heart Rate", x = "") +
  theme_minimal()

# Create a histogram for Heart Rate distribution
heart_rate_histogram <- ggplot(data, aes(x = Heart.Rate)) + 
  geom_histogram(binwidth = 1, fill = "lightblue", color = "black") +
  labs(title = "Heart Rate Distribution", x = "Heart Rate", y = "Count") +
  theme_minimal()

# Create a box plot for Daily Steps distribution
daily_steps_boxplot <- ggplot(data, aes(x = '', y = Daily.Steps)) + 
  geom_boxplot() +
  labs(title = "Daily Steps Distribution", y = "Daily Steps", x = "") +
  theme_minimal()

# Create a histogram for Daily Steps distribution
daily_steps_histogram <- ggplot(data, aes(x = Daily.Steps)) + 
  geom_histogram(binwidth = 500, fill = "lightblue", color = "black") +
  labs(title = "Daily Steps Distribution", x = "Daily Steps", y = "Count") +
  theme_minimal()

# Combine the plots into a single figure
combined_plots <- (age_boxplot | age_histogram) / 
  (quality_of_sleep_boxplot | quality_of_sleep_histogram) / 
  (physical_activity_boxplot | physical_activity_histogram) / 
  (stress_level_boxplot | stress_level_histogram) / 
  (heart_rate_boxplot | heart_rate_histogram) / 
  (daily_steps_boxplot | daily_steps_histogram) 

# Define the layout of the combined plot
combined_plot_layout <- combined_plots + 
  plot_layout(ncol = 2)

# Print the combined plot with the layout
print(combined_plot_layout)
```

**Age Distribution**:

The box plot shows an almost flat or even distribution of age. There are only a few outliers on the right side, which is indicated by this histogram. It is rather uniform across different age segments with a little spike at middle age as suggested in the diagram below.

**Quality of Sleep Distribution**:

Average could be interpreted from the box plot, from which it can be seen that values cluster slightly towards the middle, suggesting that most people have moderate sleep quality while few people have very good sleep quality occasionally. This is evidenced by the histogram where the majority of the subjects reported their sleep quality to be average and few responded they have either very good or very bad sleep quality.


**Physical Activity Level Distribution:**

When it comes to physical activity levels, the shapes of the box plots indicate that the range is wide, and the values varies significantly with some lower and upper outliers. This is perhaps the most striking characteristic of the histogram since it indicates that the sample is bimodal, as the high and low extremes of the activity scale are tightly packed. This might imply that there are two separate groups in the population: A less active regionalisation and a more active regionalisation.

**Stress Level Distribution**:


As evidenced by the box plot, stress is not a highly skewed variable because most cases are located around the midline, and there is no long tail section of extreme cases. The histogram above indicates that the distribution is relatively equal across the various stress levels, with slightly high results getting a small peak.

**Heart Rate Distribution:**

The box plot of resting heart rate denotes that the dispersion is relatively limited, that is, most people’s heart rate is fairly constant and there a few extreme cases or a few cases outside the interquartile range. The histogram indicates the distribution of Cardiac, which is normal with the peak at 70 per minute, which is normal for an adult.

**Daily Steps Distribution**:

It shows a box plot to express the range of number of daily steps where there is fluctuation in the count present in different patients, and some of the values reaching extremely high values. The histogram brought out that an increased number of people are inclined towards having low daily steps with lesser people taking a relatively higher number of steps.

```{r}
# Calculate mean, median, and mode
mean_sleep <- mean(data$Quality.of.Sleep, na.rm = TRUE)
median_sleep <- median(data$Quality.of.Sleep, na.rm = TRUE)
mode_sleep <- as.numeric(names(sort(table(data$Quality.of.Sleep), decreasing = TRUE)[1]))

# Create the histogram and add lines for mean, median, and mode
quality_of_sleep_plot <- ggplot(data, aes(x = Quality.of.Sleep)) +
  geom_histogram(aes(y = ..count..), binwidth = 1, fill = "lightblue", color = "black") +
  geom_vline(aes(xintercept = mean_sleep, color = "Mean"), linetype = "dashed", linewidth = 1) +
  geom_vline(aes(xintercept = median_sleep, color = "Median"), linetype = "dotted", linewidth = 1) +
  geom_vline(aes(xintercept = mode_sleep, color = "Mode"), linetype = "dotdash", linewidth = 1) +
  scale_color_manual(name = "Statistics", values = c("Mean" = "red", "Median" = "green", "Mode" = "blue")) +
  labs(title = "Quality of Sleep Distribution", x = "Quality of Sleep", y = "Count") +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(hjust = 0.5),
    axis.title.x = element_text(vjust = -0.2),
    axis.title.y = element_text(vjust = 1.2)
  )

# Print the plot
print(quality_of_sleep_plot)
```

TThe majority of participants provided their assessment of the quality of the night’s sleep and the results can be summarized by stating that most of them had an excellent night’s sleep, as was indicated by the scores of 7 and 8. Thus, it can also be noted that the location of the mode is above both the mean and the median, which suggests that while there is a number of people experiencing poor quality of sleep in this group, there are many more people who sleep well. 

```{r}
# Column names
quality_of_sleep_col <- "Quality.of.Sleep"
grouping_cols <- c("Gender", "Occupation", "BMI.Category", "Blood.Pressure.Category", "Sleep.Disorder")

plots <- list()


for(grouping_col in grouping_cols) {
  # Check if each group has at least two data points
  valid_groups <- data %>%
    group_by(!!sym(grouping_col)) %>%
    filter(n() > 1) %>%
    pull(!!sym(grouping_col)) %>%
    unique()
  
  # Create the density plot only for valid groups
  if (length(valid_groups) > 0) {
    p <- ggplot(data %>% filter(!!sym(grouping_col) %in% valid_groups), 
                aes_string(x = quality_of_sleep_col, fill = grouping_col)) +
      geom_density(alpha = 0.7) +
      theme_minimal() +
      labs(title = paste("Quality of Sleep by", grouping_col))
    plots[[grouping_col]] <- p
  } else {
    warning(paste("Not enough data to plot", grouping_col))
  }
}

# Check your list of plots
plots

# To display the plots
if (length(plots) > 0) {
  library(gridExtra)
  do.call(grid.arrange, c(plots, ncol = 2))
}
```

The study conclusively establishes that the men and women, employed and unemployed, with high and low BMI, high and low blood pressure and those who have and don’t have sleeping disorders have different patterns and rate of sleep quality. As based on the findings, lifestyle and health circumstances seem to influence sleep quality considerably. 


```{r}
# Boxplot for Age by Gender
age_plot <- ggplot(data, aes(x = Gender, y = Age, fill = Gender)) +
  geom_boxplot() +
  labs(title = "1. How old are they?", y = "Age", x = "Gender") +
  theme_minimal()

# Boxplot for Sleep Duration by Gender
sleep_duration_plot <- ggplot(data, aes(x = Gender, y = `Sleep.Duration`, fill = Gender)) +
  geom_boxplot() +
  labs(title = "2. How long do they sleep?", y = "Sleep.Duration", x = "Gender") +
  theme_minimal()

# Boxplot for Quality of Sleep by Gender
quality_sleep_plot <- ggplot(data, aes(x = Gender, y = `Quality.of.Sleep`, fill = Gender)) +
  geom_boxplot() +
  labs(title = "3. How well do they sleep?", y = "Quality of Sleep", x = "Gender") +
  theme_minimal()

# Combine the plots into a single plot window
library(gridExtra)
grid.arrange(age_plot, sleep_duration_plot, quality_sleep_plot, ncol = 3)
```

**Age:**

The age boxplot further portrays that there exists a tendency of women in this dataset to be relatively older than men in terms of median as depicted in the boxplot as a higher median bar for women as compared to men. Similar values indicating the range in the top and bottom of boxes and the IQR signifying the height of the boxes also suggest a similar dispersion of age for both boys and girls. The two whiskers show that there are some men and females younger than the respondents and others older than the respondents within the marginal age group categories of 25-34 and 35-44 years. However, the range here tells us that the females are older, with a higher range than males.

**Sleep Duration:**

By comparing the median sleep time between the two sexes, shown by the central slash in the boxplots, one can infer that men have slightly shorter hours of sleep than women. IQRs represent the distribution of the middle 50% of the data, and the fact that IQRs for the two genders was the same suggests this group is similar for both genders. Thus, there are tendencies in the results point to the fact that males seem to have a considerably wider distribution in sleep time than females where the variability in the results, manifesting itself as the range, is somewhat higher for males than for females.

**Quality of Sleep:**

The median line indicates therefore that, in terms of the quality of sleep, as outlined above, women seem to have a slightly higher median quality of sleep than men. In males and females, it is also the same range of dispersion of values as shown by IQR. A much wider dispersion in scores was observed for females than for males, which indicates that women’s sleep can vary to a greater extent in quality and can be exceptionally good as well as very bad.

```{r}
# Count the number of participants in each occupation
occupation_count <- data %>%
  group_by(Occupation) %>%
  summarise(Participants = n_distinct(Person.ID))

# Calculate the average quality of sleep for each occupation
avg_quality_of_sleep <- data %>%
  group_by(Occupation) %>%
  summarise(AvgQualityOfSleep = mean(Quality.of.Sleep, na.rm = TRUE))

# Number of Participants by Occupation
occupation_count_plot <- ggplot(occupation_count, aes(x = reorder(Occupation, -Participants), y = Participants)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() +
  labs(title = "1. What are their occupations?", x = "Number of participants", y = "Occupation") +
  theme_minimal()

# Average Quality of Sleep by Occupation
quality_sleep_plot <- ggplot(avg_quality_of_sleep, aes(x = reorder(Occupation, AvgQualityOfSleep), y = AvgQualityOfSleep)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() +
  labs(title = "2. Who sleeps better, and who worse?", x = "Avg Quality of Sleep", y = "Occupation") +
  theme_minimal()

# Print the plots
print(occupation_count_plot)
print(quality_sleep_plot)
```

**Occupational Distribution**:

Some demographics of the participants of the study are presented in the first chart where the distribution of participants by different vocations is depicted. The largest number of professionals are employed in the field of nursing then followed by engineering profession and then medical profession. With regard to the sample distribution, the managers/sales reps are the least ranked. It could mean that this is the actual proportion of the population from which participants were sampled, or, it could mean that it is indicative of the willingness or availability of different occupations to be involved in the study.

**Average Quality of Sleep by Occupation**:

The power point continues with the second graph that compares the average sleep quality of different professions. This reveals that engineers have the best quality of sleep than the other professions: then followed by accountants and attorneys. On the other hand, it is seen that scientists and sales people get the least quality sleep, on average, and this may be due to work related problems or may be the they have stress on their work. Alas, even crucial attendants of our health, doctors do not necessarily sleep better than ordinary working individuals, this is evidenced by the fact that, while expanding a list of people studied – doctors took a significant part, their average night’s rest is not the best.

```{r}
# Count of participants by Sleep Disorder
sleep_disorder_count <- ggplot(data, aes(x = Sleep.Disorder)) +
  geom_bar(fill = "skyblue") +
  labs(title = "1. How many suffer from Sleep Disorders?", x = "Sleep Disorder", y = "Number of Participants") +
  theme_minimal()

# Average Quality of Sleep by Sleep Disorder
avg_sleep_quality_by_disorder <- ggplot(data, aes(x = Sleep.Disorder, y = Quality.of.Sleep)) +
  geom_bar(stat = "summary", fun = "mean", fill = "skyblue") +
  labs(title = "2. Who sleeps better?", x = "Sleep Disorder", y = "Avg Sleep Quality") +
  theme_minimal()

# Sleep quality boxplot by Sleep Disorder
sleep_quality_boxplot <- ggplot(data, aes(x = Sleep.Disorder, y = Quality.of.Sleep)) +
  geom_boxplot(fill = "skyblue") +
  labs(title = "3. Sleep quality boxplot by Sleep Disorders", x = "Sleep.Disorder", y = "Sleep.Quality") +
  theme_minimal()

# Print the plots
print(sleep_disorder_count)
print(avg_sleep_quality_by_disorder)
print(sleep_quality_boxplot)
```

**Prevalence of Sleep Disorders**:

The pictorial data given for different sleep problems is in the form of a bar graph showing the count of people affected. Hence, it is clear that majority of people do not have any sleep disorder problem; however the most common sleeping disorder is insomnia while the least is sleep apnea.

**Average Sleep Quality by Sleep Disorder**:

From this bar graph, it can be clearly seen that persons who did not have any sleep problem represented the highest group with the highest average sleep quality rating, thus implying that their sleep was of better quality than the rest. Insomnia and sleep apnea disease involve diseases of the human body, and participants diagnosed with these diseases receive lower scores, suggesting poor sleep quality .

**Sleep Quality Distribution by Sleep Disorder**:

It shows the status of sleep quality of each sleep disorder category using the box plot. Lastly, they found that people who did not have sleep disorders had the highest median sleep quality. The participants with insomnia have the lowest score in median sleep quality and higher IQR which also show that there is more variations in their sleep quality. The ‘Sleep Apnea’ group has a larger median sleep quality compared to the ‘Insomnia’ group However, the IQR for the ‘Sleep Apnea’ group is larger than that of the ‘Insomnia’ group meaning there is variation in sleep quality among individuals with this disease.

```{r}
# BMI Data Plotting
# Count the number of participants in each BMI category
bmi_counts <- data %>%
  group_by(BMI.Category) %>%
  summarise(Number.of.Participants = n())

# Calculate the average quality of sleep for each BMI category
bmi_quality <- data %>%
  group_by(BMI.Category) %>%
  summarise(Avg.Quality.of.Sleep = mean(Quality.of.Sleep, na.rm = TRUE))

# Bar plot for BMI category participant count
bmi_count_plot <- ggplot(bmi_counts, aes(x = BMI.Category, y = Number.of.Participants, fill = BMI.Category)) +
  geom_bar(stat = "identity") +
  labs(title = "1. What is your BMI category?", x = "BMI Category", y = "Number of participants") +
  theme_minimal()

# Bar plot for average quality of sleep by BMI category
bmi_quality_plot <- ggplot(bmi_quality, aes(x = BMI.Category, y = Avg.Quality.of.Sleep, fill = BMI.Category)) +
  geom_bar(stat = "identity") +
  labs(title = "2. Who sleeps better?", x = "BMI Category", y = "Avg Quality of Sleep") +
  theme_minimal()

# Boxplot for quality of sleep by BMI category
bmi_quality_boxplot <- ggplot(data, aes(x = BMI.Category, y = Quality.of.Sleep, fill = BMI.Category)) +
  geom_boxplot() +
  labs(title = "3. Sleep quality boxplot by BMI Category", x = "BMI Category", y = "Quality of Sleep") +
  theme_minimal()

# Display the plots
bmi_count_plot
bmi_quality_plot
bmi_quality_boxplot
```

**BMI Category Distribution**:

The first figure is a bar chart to show the participants in each BMI category. The preponderance of the participants was in the ‘Normal’ BMI, and less number in the ‘Overweight’ group and a very negligible number in the ‘Obese’ group.

**Average Quality of Sleep by BMI Category**:

The second bar chart illustrates the average sleep quality to BMI groupings on a scale inconsistent indicated but most likely bounded by 1 or 10. Of all the groups, the ‘Normal’ BMI seems to enjoy the best average quality of sleep, followed by ‘Overweight’ and ‘Obese’ persons, who report a lower value than the ‘Normal’ BMI. But again, discrepancies are exhibited across the groups seem to be small.

**Sleep Quality Boxplot by BMI Category**:
The last graphic is a boxplot that provides for a broader picture of the distribution of sleep quality ratings in each bracket of BMI. The ‘Normal’ BMI value has the highest median sleep quality thus its large variance due to one participant who has a very poor sleep quality result. As seen in the ‘Obese’ category, the interquartile range is relatively weak, implying that sleep quality slightly differs a lot among the individuals. The ‘Overweight’ group has the sleep quality which is lower than in ‘Normal’ group but higher than in ‘Obese’ and, moreover, has got the smaller interquartile range than ‘Obese’ category, thus pointing to the higher homogeneity of sleep indicators in ‘Overweight’ people.

```{r}
# Blood Pressure Data Plotting
# Repeat the same process for blood pressure data
bp_counts <- data %>%
  group_by(Blood.Pressure.Category) %>%
  summarise(Number.of.Participants = n())

bp_quality <- data %>%
  group_by(Blood.Pressure.Category) %>%
  summarise(Avg.Quality.of.Sleep = mean(Quality.of.Sleep, na.rm = TRUE))

bp_count_plot <- ggplot(bp_counts, aes(x = Blood.Pressure.Category, y = Number.of.Participants, fill = Blood.Pressure.Category)) +
  geom_bar(stat = "identity") +
  labs(title = "1. How is your Blood Pressure level?", x = "Blood Pressure Category", y = "Number of participants") +
  theme_minimal()

bp_quality_plot <- ggplot(bp_quality, aes(x = Blood.Pressure.Category, y = Avg.Quality.of.Sleep, fill = Blood.Pressure.Category)) +
  geom_bar(stat = "identity") +
  labs(title = "2. Who sleeps better?", x = "Blood Pressure Category", y = "Avg Quality of Sleep") +
  theme_minimal()

bp_quality_boxplot <- ggplot(data, aes(x = Blood.Pressure.Category, y = Quality.of.Sleep, fill = Blood.Pressure.Category)) +
  geom_boxplot() +
  labs(title = "3. Sleep Quality boxplot by Blood Pressure Category", x = "Blood Pressure Category", y = "Quality of Sleep") +
  theme_minimal()

# Display the plot
bp_count_plot
bp_quality_plot
bp_quality_boxplot
```

**Blood Pressure Level Distribution**:

The bar chart represent the incremented percentage on the basis of blood pressure categories of the participants. The largest proportion comprises the group with normal levels of blood pressure, and the second largest with the group having high blood pressure, while the smallest proportion of the population comprises the group with ideal blood pressure. From the graph above it is evident that the majority of individuals have normal blood pressure levels.

**Average Sleep Quality by Blood Pressure Category**:

The bar chart where similar to the previous one shows the average of sleep quality depending on the same groups of blood pressure. Most surprisingly, people with ideal BP had the most desirable average sleep quality while the normotensive had a slightly worse average sleep quality compared to the hypertensives who had the worst sleep quality. This leads to a notion that low blood pressure is associated with better quality sleep than the high blood pressure.

**Sleep Quality Boxplot by Blood Pressure Category**:

The containing boxplot depicting how the quality of sleep changes with respect to different blood pressure groups. Comparing the boxplot for hypertension and normal blood pressure, the former has higher range and the middle-adjoining, with median sleep quality scores higher than the other, and box plot more compacted with a slightly lower median. Thus, the results showed that the ideal blood pressure group has a higher median compare to two other groups, but when evaluating outliers, it can be stated that there are people with ideal blood pressure value, who experience poor sleep quality. This graph shows that for those with the ideal blood pressure, they have higher overall average sleep quality, however, it’s clear that there are different degrees of this within each group.


```{r}
# Select only the numeric columns from the data
numeric_data <- data[sapply(data, is.numeric)]

# Calculating the correlation matrix
cor_matrix <- cor(numeric_data, use = "complete.obs")

# Create the correlation heatmap
corrplot(cor_matrix, method = "color", type = "upper", 
         tl.col = "black", tl.srt = 45,
         diag = FALSE)  

```

- The scale to the right offer how strong the correlation is and value ranges from -1 to 1.

- When the coefficient is close to 1, it means that the data marked has a strong positive relationship, and in simpler terms, it means that if one variable increases, the other also experiences an equivalent increase.

- A coefficient of approximately -1 means that the relationship has a strong negative form, that negative changes in the first variable are followed by negative changes in the second variable.

- If the coefficient is about zero, then it also suggests that there is a negligible or no straight line relationship between the said variables.

Hence, it could be ascertained that there is a fairly strong negative correlation between ‘Age’ and ‘Person. ID’, which is quite rare and suggests that ‘Person. ID’ might have a quantitative relation to age. Nonetheless, any ID should not tie it to age, other than a random numbering system in accordance with age. The study of correlation reveal that there is a positive relationship between between the variable “Quality of Sleep” and the variable “Physical Activity Level” which may suggest that those who are more physically active may enjoy better quality of sleep. While examining the correlation between “Stress Level” and “Systolic Pressure” and “Diastolic Pressure”, it can be suggested that Stress Level has a moderate positive relationship with them, meaning that higher stress correlates with higher blood pressure. This correlation shows that there is a negative correlation between the “Daily Steps” and the “Heart Rate;” therefore, more daily steps are likely to mean a lower resting heart rate, which in this context, is a sign of good health especially in regards to the cardiovascular system.

```{r}
# Scatter plot of Sleep Duration vs Quality of Sleep
plot1 <- ggplot(data, aes(x = Quality.of.Sleep, y = Sleep.Duration)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "Long Rest = Good Rest",
       x = "Quality of Sleep",
       y = "Sleep Duration (hours)")

# Scatter plot of Stress Level vs Quality of Sleep
plot2 <- ggplot(data, aes(x = Quality.of.Sleep, y = Stress.Level)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "More Stress = Bad Rest",
       x = "Quality of Sleep",
       y = "Stress Level")

#Show the plots
plot1
plot2
```

**Long Rest = Good Rest**:

In the first figure we can see a trend positive correlation between the length of sleep and sleep quality. The time devoted to sleep also rises as the scores relating to sleep quality go higher, which means that people who have higher sleep quality get more sleep. When analyzing the changes in data points, it can be noted that the higher the subjective perceived sleep quality, the greater the correlation with the obtained results: most of the points are clustered near the trend line in this case. \

**More Stress = Bad Rest**:

The second figure only draws a negative correlation between stress and sleep quality. The increased stress was thus associated with lower sleep quality as the stress levels intensify, the quality of sleep reduces. The further down the plot, the line indicates reduced stress levels, and in general, all the data points are oriented lower along the X-axis and reflect the trend of lower stress levels being connected to better sleep quality. \

```{r}
# Scatter plot of Physical Activity Level vs Sleep Quality
plot3 <- ggplot(data, aes(x = Quality.of.Sleep, y = Physical.Activity.Level)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "A: Sleep quality based on physical activity",
       x = "Sleep Quality",
       y = "Physical Activity Level (minutes)")

# Scatter plot of Age vs Sleep Duration
plot4 <- ggplot(data, aes(x = Age, y = Sleep.Duration)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "B: The older you get, the more you sleep",
       x = "Age",
       y = "Sleep Duration (hours)")

# Scatter plot of Heart Rate vs Sleep Duration
plot5 <- ggplot(data, aes(x = Heart.Rate, y = Sleep.Duration)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "C: Quickest Heartbeat, Fewest Sleep",
       x = "Heart Rate",
       y = "Sleep Duration (hours)")

# Scatter plot of Physical Activity vs Sleep Duration
plot6 <- ggplot(data, aes(x = Physical.Activity.Level, y = Sleep.Duration)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "D: Engaging in physical exercise can facilitate sleep",
       x = "Physical Activity",
       y = "Sleep Duration (hours)")

#Show the plots
plot3
plot4
plot5
plot6
```

**Sleep Quality by Physical Activity**:

There is a positive relationship between physical activity, in minutes and sleep quality. That is, as physical activity increases so does the sleep quality score. The shaded area is the confidence interval showing a bit of uncertainty around the trend line but in general more physical activity is associated with higher sleep quality.

**Sleep Duration and Age**:

This graph shows a positive relationship between age and sleep duration, in hours. The sleep duration is increasing with age indicating that older people sleep more rather than less. However the scattering of points shows by how much this can vary, and the extent to which other factors may be involved.

**Sleep Duration and Heart Rate**:

This graph will help to support a negative relationship between heart rate and sleep duration. That is, the higher the heart rate, the shorter the duration of sleeping. Indeed, the trend line shows a decrease as the heart rate increases, thereby justifying this assumption.

**Sleep Duration and Physical Activity**:

This graph indicates that, indeed, there is a positive relationship between sleep duration and physical activity. This means the more an individual is physically active, the longer he or she is going to sleep. This graph therefore supports the argument that exercises help an individual to sleep longer.

```{r}
# Scatter plot of Heartbeat vs Stress Lvevel
plot7 <- ggplot(data, aes(x = Heart.Rate, y = Stress.Level)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "A: Increased stress leads to quicker heartbeats",
       x = "Heartbeat",
       y = "Stress Level")

# Scatter plot of Heartbeat vs Quality of Sleep
plot8 <- ggplot(data, aes(x = Heart.Rate, y = Quality.of.Sleep)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "B: Faster pulse, worse quality of sleep",
       x = "Heartbeat",
       y = "Quality of Sleep")

#Show the plots
plot7
plot8
```

**Increased stress leads to quicker heartbeats**:

This scatter plot with a regression line demonstrates a positive link between heart rate and stress level. As the heart rate increases, so does the stress level. The shaded region surrounding the regression line represents the prediction's confidence interval, indicating that while there is some uncertainty in the connection, the overall trend is positive.\

**Faster pulse, worse quality of sleep**:

This scatter figure, which includes a regression line, shows a negative link between heart rate and sleep quality. As the heart rate rises, the quality of sleep appears to deteriorate. The confidence interval is likewise shaded, indicating variability while maintaining an overall decreasing trend.\

```{r}
# Scatter plot of Physical Activity based on Sleep Quality
plot9 <- ggplot(data, aes(x = Physical.Activity.Level, y = Quality.of.Sleep)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "A: Physical Activity based on Sleep Quality",
       x = "Physical Activity",
       y = "Sleep Quality")

# Scatter plot of Sleep Duration based on Sleep Quality
plot10 <- ggplot(data, aes(x = Sleep.Duration, y = Quality.of.Sleep)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "B: Sleep Duration based on Sleep Quality",
       x = "Sleep Duration",
       y = "Quality of Sleep")

#Show the plots
plot9
plot10
```

**Sleep Quality based on Physical Activity:**

This scatter plot demonstrates a favorable correlation between physical exercise and sleep quality. As physical activity levels rise, sleep quality appears to improve lightly.

**Sleep Quality based on Heartbeat:**

This graph illustrates a positive correlation between sleep duration and sleep quality.

```{r}
# Scatter plot of Stress Level based on Physical Activity
plot11 <- ggplot(data, aes(x = Physical.Activity.Level , y = Stress.Level)) +
  geom_point() +
  geom_smooth(method = lm, se = TRUE) +
  labs(title = "Physical Activity Level based on Stress Level",
       x = "Physical Activity Level",
       y = "Stress Level")

#Show the plot
plot11
```

**Stress Level based on Physical Activity:**

This scatter plot depicts the association between physical activity (x-axis) and stress level (y-axis).\

```{r}
# Scatter plot of Sleep Duration vs Age with BMI categories
p1 <- ggplot(data, aes(x = Age, y = Sleep.Duration, color = BMI.Category)) +
  geom_point() +
  ggtitle("Sleep Duration vs Age with BMI categories") +
  theme_minimal()

ggMarginal(p1, type = "histogram")
```

```{r}
# Scatter plot of Quality of Sleep vs Age with BMI categories
p2 <- ggplot(data, aes(x = Age, y = Quality.of.Sleep, color = BMI.Category)) +
  geom_point() +
  ggtitle("Quality of Sleep vs Age with BMI categories") +
  theme_minimal()

ggMarginal(p2, type = "histogram")
```

```{r}
# Scatter plot of Quality of Sleep vs HeartRate with Sleep Disorder categories
p3 <- ggplot(data, aes(x = Heart.Rate, y = Quality.of.Sleep, color = Sleep.Disorder)) +
  geom_point() +
  ggtitle("Quality of Sleep vs Heart Rate with Sleep Disorder") +
  theme_minimal()

ggMarginal(p3, type = "histogram")
```

```{r}
# Scatter plot of Quality of Sleep vs Stress Level with Sleep Disorder categories
p4 <- ggplot(data, aes(x = Stress.Level, y = Quality.of.Sleep, color = Sleep.Disorder)) +
  geom_point() +
  ggtitle("Sleep vs Stress Level with Sleep Disorder") +
  theme_minimal()

ggMarginal(p4, type = "histogram")

```

```{r}

# Scatter plot of Quality of Sleep vs Blood Preassure
p5 <- ggplot(data, aes(x = Heart.Rate, y = Quality.of.Sleep, color = Blood.Pressure.Category)) +
  geom_point() +
  ggtitle("Heartbeat vs Blood Pressure") +
  theme_minimal()

ggMarginal(p5, type = "histogram")
```

## Machine Learning

**Linear Regression**
```{r}
# Response and predictor variables
y <- data$Quality.of.Sleep
X <- data %>% select(Sleep.Duration, Age, Physical.Activity.Level, Stress.Level, Heart.Rate, Daily.Steps)

# Add a constant column for the intercept
X <- cbind(Intercept = 1, X)

# Split the data into training and testing sets (70% train, 30% test)
set.seed(42)  # For reproducibility
split <- sample.split(y, SplitRatio = 0.7)
X_train <- subset(X, split == TRUE)
X_test <- subset(X, split == FALSE)
y_train <- subset(y, split == TRUE)
y_test <- subset(y, split == FALSE)

# Fit the OLS model to the training data
model <- lm(y_train ~ ., data = as.data.frame(X_train))
summary(model)
```
**Interpretation of Model Summary**:

Output indicates that the predictors Sleep Duration, Age, Stress Level, Heart Rate, and Daily Steps are significant, while Physical Activity Level is not. The model's high R-squared (0.9152) and Adjusted R-squared (0.9133) values indicate a strong fit. \

```{r}
```
```{r}
# Remove Physical Activity Level from the predictors
X <- data %>% select(Age, Sleep.Duration, Stress.Level, Heart.Rate, Daily.Steps)
X <- cbind(Intercept = 1, X)

# Split the data into training and testing sets (70% train, 30% test)
set.seed(42)  # For reproducibility
split <- sample.split(y, SplitRatio = 0.7)
X_train <- subset(X, split == TRUE)
X_test <- subset(X, split == FALSE)
y_train <- subset(y, split == TRUE)
y_test <- subset(y, split == FALSE)

# Fit the new OLS model to the training data
model_refined <- lm(y_train ~ ., data = as.data.frame(X_train))
summary(model_refined)

```
```{r}
# Define MAE function
mae <- function(y, pred) {
  return(round(mean(abs(y - pred)), 2))
}

# Predictions on training data with refined model
pred_train_refined <- predict(model_refined, newdata = as.data.frame(X_train))

# MAE for training data with refined model
naive_mae_train <- mae(y_train, mean(y_train))
model_mae_train_refined <- mae(y_train, pred_train_refined)

print(paste('Naïve Training MAE:', naive_mae_train))
print(paste('Training MAE with refined model:', model_mae_train_refined))

# Plotting distribution of errors for refined model
ggplot(data.frame(error = y_train - pred_train_refined), aes(x = error)) +
  geom_histogram(binwidth = 0.1, fill = 'blue', color = 'black') +
  ggtitle("Distribution of errors (train) with refined model")

ggplot(data.frame(abs_error = abs(y_train - pred_train_refined)), aes(x = abs_error)) +
  geom_histogram(binwidth = 0.1, fill = 'blue', color = 'black') +
  ggtitle("Distribution of absolute errors (train) with refined model")

# Predictions on test data with refined model
pred_test_refined <- predict(model_refined, newdata = as.data.frame(X_test))

# MAE for test data with refined model
naive_mae_test <- mae(y_test, mean(y_test))
model_mae_test_refined <- mae(y_test, pred_test_refined)

print(paste('Naïve Testing MAE:', naive_mae_test))
print(paste('Testing MAE with refined model:', model_mae_test_refined))

# Plotting distribution of errors for refined model
ggplot(data.frame(error = y_test - pred_test_refined), aes(x = error)) +
  geom_histogram(binwidth = 0.1, fill = 'blue', color = 'black') +
  ggtitle("Distribution of errors (test) with refined model")

ggplot(data.frame(abs_error = abs(y_test - pred_test_refined)), aes(x = abs_error)) +
  geom_histogram(binwidth = 0.1, fill = 'blue', color = 'black') +
  ggtitle("Distribution of absolute errors (test) with refined model")

```
**Improved Model **:

By removing an insignificant predictor (Physical.Activity.Level), multicollinearity issues are likely reduced, resulting in more reliable estimates of the coefficients.
The refined model maintains a high R-squared (0.9152) and Adjusted R-squared (0.9136), indicating that the model still explains a significant portion of the variance in the response variable.
The F-statistic is very high and significant, suggesting that the overall model is a good fit.\

**Mean Absolute Error **:

The Training MAE for the refined model (0.27) is much lower than the Naïve Training MAE (1.05), indicating that the model fits the training data well.
The Testing MAE for the refined model (0.31) is also lower than the Naïve Testing MAE (1.03), showing good predictive performance on the test data.
The similarity between Training MAE (0.27) and Testing MAE (0.31) suggests that the model does not overfit the training data and generalizes well to unseen data.
.\

**Gradient Boosting Machine**
In this part of the project, we implemented a Gradient Boosting Machine (GBM) model to predict the quality of sleep based on various factors such as sleep duration, age, physical activity level, stress level, heart rate, and daily steps. We began by defining a grid of hyperparameters to tune the model, including the number of trees, interaction depth, shrinkage (learning rate), and minimum observations in the terminal nodes. We set up a 5-fold cross-validation to robustly evaluate the model's performance and prevent overfitting. The data was split into training (70%) and testing (30%) sets, and the GBM model was trained using the defined hyperparameters and cross-validation settings.


```{r}
# Splitting the data into training (70%) and testing (30%) sets
set.seed(455) 
trainIndex <- createDataPartition(data$`Quality.of.Sleep`, p = 0.7, list = FALSE)
trainData <- data[trainIndex, ]
testData <- data[-trainIndex, ]

```


```{r}

# Defining the hyperparameter grid
grid <- expand.grid(
  n.trees = c(25, 50, 100, 150),       # Number of trees
  interaction.depth = c(1, 2),     # Depth of each tree
  shrinkage = c(0.05, 0.1, 0.15),  # Learning rate
  n.minobsinnode = c(5, 10)        # Minimum number of observations in the terminal nodes
)


# Setting up the training control with 5-fold cross-validation
train_control <- trainControl(method = "cv", number = 5)
```


```{r}
# Training the model using the grid search
set.seed(455) # For reproducibility
gbm_tuned <- train(
  `Quality.of.Sleep` ~ `Sleep.Duration` + Age + `Physical.Activity.Level` + `Stress.Level` + `Heart.Rate` + `Daily.Steps`,
  data = trainData,
  method = "gbm",
  trControl = train_control,
  tuneGrid = grid,
  verbose = FALSE
)

```


```{r}
# Predictions on training data with gbm_tuned model
pred_train_gbm_tuned <- predict(gbm_tuned, newdata = trainData)

mae <- function(y, pred) {
  return(round(mean(abs(y - pred)), 2))
}

# MAE for training data with gbm_tuned model
naive_mae_train <- mae(trainData$`Quality.of.Sleep`, mean(trainData$`Quality.of.Sleep`))
model_mae_train_gbm_tuned <- mae(trainData$`Quality.of.Sleep`, pred_train_gbm_tuned)

print(paste('Naive Training MAE:', naive_mae_train))
print(paste('Training MAE with gbm_tuned model:', model_mae_train_gbm_tuned))

# Plotting distribution of errors for gbm_tuned model on training data
ggplot(data.frame(error = trainData$`Quality.of.Sleep` - pred_train_gbm_tuned), aes(x = error)) +
  geom_histogram(binwidth = 0.1, fill = 'blue', color = 'black') +
  ggtitle("Distribution of errors (train) with gbm_tuned model")

ggplot(data.frame(abs_error = abs(trainData$`Quality.of.Sleep` - pred_train_gbm_tuned)), aes(x = abs_error)) +
  geom_histogram(binwidth = 0.1, fill = 'blue', color = 'black') +
  ggtitle("Distribution of absolute errors (train) with gbm_tuned model")

# Predictions on test data with gbm_tuned model
pred_test_gbm_tuned <- predict(gbm_tuned, newdata = testData)

# MAE for test data with gbm_tuned model
naive_mae_test <- mae(testData$`Quality.of.Sleep`, mean(testData$`Quality.of.Sleep`))
model_mae_test_gbm_tuned <- mae(testData$`Quality.of.Sleep`, pred_test_gbm_tuned)

print(paste('Naive Testing MAE:', naive_mae_test))
print(paste('Testing MAE with gbm_tuned model:', model_mae_test_gbm_tuned))

# Plotting distribution of errors for gbm_tuned model on test data
ggplot(data.frame(error = testData$`Quality.of.Sleep` - pred_test_gbm_tuned), aes(x = error)) +
  geom_histogram(binwidth = 0.1, fill = 'blue', color = 'black') +
  ggtitle("Distribution of errors (test) with gbm_tuned model")

ggplot(data.frame(abs_error = abs(testData$`Quality.of.Sleep` - pred_test_gbm_tuned)), aes(x = abs_error)) +
  geom_histogram(binwidth = 0.1, fill = 'blue', color = 'black') +
  ggtitle("Distribution of absolute errors (test) with gbm_tuned model")
```

**Summary of Gradient Boosting Machine**
The naive MAE represents the error when predicting the mean value of the quality of sleep for all instances, serving as a baseline for comparison. The substantial reduction in MAE from the naive model (1.08) to the tuned GBM model (0.11) on the testing set indicates a significant improvement in predictive accuracy. Similarly, the training MAE for the GBM model (0.08) is much lower than the naive training MAE (1.03), demonstrating that the model effectively learned the patterns in the training data. These results suggest that the GBM model is well-tuned and capable of making accurate predictions, with minimal error, on both the training and testing datasets.



\

\

## References

- American Psychiatric Association. (n.d.). What are sleep disorders? Retrieved June 15, 2024, from https://www.psychiatry.org/patients-families/sleep-disorders/what-are-sleep-disorders

- Cleveland Clinic. (n.d.). Sleep apnea. Retrieved June 15, 2024, from https://my.clevelandclinic.org/health/diseases/8718-sleep-apnea

- Giacometti, A. (n.d.). Sleep health analysis: How to sleep better. Retrieved June 15, 2024, from https://www.kaggle.com/code/alessandrogiacometti/sleep-health-analysis-how-to-sleep-better

- Mayo Clinic. (n.d.). Insomnia: Symptoms & causes. Retrieved June 15, 2024, from https://www.mayoclinic.org/diseases-conditions/insomnia/symptoms-causes/syc-20355167

- Ministero della Salute. (n.d.). Ipertensione arteriosa. Retrieved June 15, 2024, from https://www.salute.gov.it/portale/alleanzaCardioCerebrovascolari/dettaglioSchedeAlleanzaCardioCerebrovascolari.jsp?lingua=italiano&id=18&area=Alleanza%20italiana%20per%20le%20malattie%20cardio-cerebrovascolari&menu=malattie

- OpenAI. (2024). Personal communication via ChatGPT [Personal correspondence]. June 15, 2024.
